<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- This page allows Transfer Visualizer to be run on database free tests, without a web server. -->
<head>
    <title>Transfer Visualizer</title>
    <style>
        /*@import url(../style.css);*/
        .background {
            stroke: white;
            stroke-width: 1px;
            fill: white;
        }

        .node {
            stroke: black;
            stroke-width: 1.5px;
            cursor: move;
            fill: #8dedf0;
        }

        .link {
            fill: none;
            stroke: #000;
            stroke-width: 3px;
            opacity: 0.7;
            marker-end: url(#end-arrow);
        }

        .label {
            fill: black;
            font-family: Arial;
            font-size: 12px;
            text-anchor: middle;
            cursor: move;
        }
    </style>
</head>
<body>
<script src="../../../../src/main/webapp/resources/scripts/d3.3.5.6.min.js"></script>
<script>
    var width = 1200, height = 950;

    var svg = d3.select("body").append("svg")
            .attr({width: width, height: height, "pointer-events": "all"});

    svg.append('rect')
            .attr({class: 'background', width: "100%", height: "100%"})
            .call(d3.behavior.zoom().on("zoom", redraw));

//    var vis = svg
//            .append('g')
//            .attr('transform', 'translate(250,250) scale(0.3)');

    function redraw() {
        svg.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")");
    }

    svg.append('svg:defs').append('svg:marker')
            .attr({
                id: 'end-arrow',
                viewBox: '0 -5 10 10',
                refX: 8,
                markerWidth: 6,
                markerHeight: 6,
                orient: 'auto'
            })
            .append('svg:path')
            .attr({
                d: 'M0,-5L10,0L0,5L2,0',
                'stroke-width': '0px',
                fill: '#000'
            });

    d3.json("XfrVis.json", function (error, json) {

        var linkDistance = 60;
        var force = d3.layout.force()
                .gravity(.08)
                .linkDistance(linkDistance)
                .charge(-120)
                .size([width, height]);

        var drag = force.drag()
                .on("dragstart", dragstart);

        force.nodes(json.nodes)
                .links(json.links)
                .start();

        var link = svg.selectAll(".link")
                .data(json.links)
                .enter().append("line")
                .attr("class", "link");

        var margin = 10, pad = 12;
        var node = svg.selectAll(".node")
                .data(json.nodes)
                .enter().append("g")
                .attr("class", "node")
                .on("dblclick", dblclick)
                .call(force.drag);

        node.append("rect")
                .attr("width", function (d) {
                    return d.w;
                })
                .attr("height", function (d) {
                    return d.h;
                });

        var nodeChildEnter = node.selectAll(".nodeChild")
                .data(function (d) {
                    return d.children;
                })
                .enter();

        var nodeChild = nodeChildEnter.append("rect")
                .attr("class", "nodeChild")
                .attr("x", function (d) {
                    return d.x;
                })
                .attr("y", function (d) {
                    return d.y;
                })
                .attr("width", function (d) {
                    return d.w;
                })
                .attr("height", function (d) {
                    return d.h;
                });

        nodeChildEnter.append("text")
                .attr("class", "label")
                .attr("x", function (d) {
                    return d.x;
                })
                .attr("y", function (d) {
                    return d.y;
                })
                .attr("dx", 25)
                .attr("dy", 10)
                .text(function (d) {
                    return d.name;
                })
                .each(function (d) {
                    var b = this.parentNode.getBBox();
                    var extra = 2 * margin + 2 * pad;
                    d.width = b.width + extra;
                    d.height = b.height + extra;
                });

        node.append("text")
                .attr("class", "label")
                .attr("dx", 25)
                .attr("dy", 10)
                .text(function (d) {
                    return d.name;
                })
                .each(function (d) {
                    var b = this.parentNode.getBBox();
                    var extra = 2 * margin + 2 * pad;
                    d.width = b.width + extra;
                    d.height = b.height + extra;
                });

        force.on("tick", function (e) {
            // Push sources up and targets down to form a weak tree.
            var k = linkDistance * 2 * e.alpha;
            json.links.forEach(function (d, i) {
                d.source.y -= k;
                d.target.y += k;
            });
            link
                    .attr("x1", function (d) {
                        return d.source.x;
                    })
                    .attr("y1", function (d) {
                        return d.source.y;
                    })
                    .attr("x2", function (d) {
                        return d.target.x;
                    })
                    .attr("y2", function (d) {
                        return d.target.y;
                    });

            node.attr("transform", function (d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
        });
    });
    function dblclick(d) {
        d3.select(this).classed("fixed", d.fixed = false);
    }
    function dragstart(d) {
        d3.select(this).classed("fixed", d.fixed = true);
    }
    function isIE() {
        return ((navigator.appName == 'Microsoft Internet Explorer') || ((navigator.appName == 'Netscape') &&
        (new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})").exec(navigator.userAgent) != null)));
    }
</script>
</body>
</html>