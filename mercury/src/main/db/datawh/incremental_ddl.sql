-- --------------------------------
-- https://gpinfojira.broadinstitute.org/jira/browse/GPLIM-5368
-- Add CALIBRATION_VERSION column to mercury DW ETL view LIBRARY_LCSET_SAMPLE
-- --------------------------------

CREATE OR REPLACE FORCE EDITIONABLE VIEW MERCURYDW.LIBRARY_LCSET_SAMPLE (
    LIBRARY_LABEL
  --, LIBRARY_ID
  , POSITION
  , LCSET_SAMPLE
  , BATCH_NAME
  , MOLECULAR_BARCODE
  , PRODUCT_ORDER_KEY
  , PRODUCT_ORDER_SAMPLE
  , LIBRARY_TYPE
  , LIBRARY_CREATION_DATE
  --, PROGRAM_NAME
  , CALIBRATION_VERSION
  --, LIBRARY_EVENT_ID
) AS
  SELECT SB.LIBRARY_LABEL
    --, SB.LIBRARY_ID
    , EF.POSITION
    , EF.LCSET_SAMPLE_NAME AS LCSET_SAMPLE
    , EF.BATCH_NAME
    , EF.MOLECULAR_INDEXING_SCHEME AS MOLECULAR_BARCODE
    , PDO.JIRA_TICKET_KEY AS PRODUCT_ORDER_KEY
    , EF.SAMPLE_NAME AS PRODUCT_ORDER_SAMPLE
    , SB.LIBRARY_TYPE
    , SB.LIBRARY_CREATION_DATE
    --, EF.PROGRAM_NAME
    , CASE WHEN SB.LIBRARY_TYPE = 'Calibrated Pooled'
    THEN DECODE(EF.PROGRAM_NAME, 'Bravo', 'v1', SUBSTR(EF.PROGRAM_NAME, INSTR(EF.PROGRAM_NAME, 'v', -1)))
      ELSE NULL
      END AS CALIBRATION_VERSION
  --, SB.LIBRARY_EVENT_ID
  FROM LIBRARY_LCSET_SAMPLE_BASE SB
    , EVENT_FACT EF
    , PRODUCT_ORDER PDO
  WHERE EF.LAB_EVENT_ID = SB.LIBRARY_EVENT_ID
        AND EF.LAB_VESSEL_ID = SB.LIBRARY_ID
        AND PDO.PRODUCT_ORDER_ID(+) = EF.PRODUCT_ORDER_ID
        AND EF.LCSET_SAMPLE_NAME IS NOT NULL;
