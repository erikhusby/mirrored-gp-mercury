<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <!-- changeSet ids include the ticket number, with -n appended to allow multiple changeSets per ticket.
     Keep changeSets small, it's harder to recover from an error in a large changeSet.
      -->
    <!--
        <changeSet id="GPLIM-55-1" author="thompson">
            <preConditions>
                <not>
                    <tableExists tableName="test" schemaName="mercury"/>
                </not>
            </preConditions>
            <comment>Testing Liquibase</comment>
            <createTable tableName="test" schemaName="mercury">
                <column name="test_id" type="int">
                    <constraints primaryKey="true" nullable="false"/>
                </column>
                <column name="name" type="varchar(50)">
                    <constraints nullable="false"/>
                </column>
                <column name="active" type="boolean" defaultValueBoolean="true"/>
            </createTable>
        </changeSet>
    -->

    <changeSet id="GPLIM-73-1" author="thompson">
        <createTable tableName="lab_vessel_mercury_samples" schemaName="mercury">
            <column name="lab_vessel" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="mercury_samples" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="lab_vessel_mercury_samples" schemaName="mercury" columnNames="lab_vessel, mercury_samples"/>
    </changeSet>
    <changeSet id="GPLIM-73-2" author="thompson">
        <createTable tableName="lab_vessel_mercury_samples_aud" schemaName="mercury">
            <column name="rev" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="lab_vessel" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="mercury_samples" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="revtype" type="number(3,0)">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="lab_vessel_mercury_samples_aud" schemaName="mercury" columnNames="rev, lab_vessel, mercury_samples"/>
    </changeSet>
    <changeSet id="GPLIM-73-3" author="thompson">
        <createTable tableName="mercury_sample" schemaName="mercury">
            <column name="mercury_sample_id" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="product_order_key" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="sample_key" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="mercury_sample" schemaName="mercury" columnNames="mercury_sample_id"/>
        <createIndex tableName="mercury_sample" indexName="ix_ms_sample_key">
            <column name="sample_key"/>
        </createIndex>
        <createSequence sequenceName="SEQ_MERCURY_SAMPLE" schemaName="mercury" startValue="1" incrementBy="50"/>
    </changeSet>
    <changeSet id="GPLIM-73-4" author="thompson">
        <createTable tableName="mercury_sample_aud" schemaName="mercury">
            <column name="mercury_sample_id" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="rev" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="revtype" type="number(3,0)">
                <constraints nullable="true"/>
            </column>
            <column name="product_order_key" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="sample_key" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="mercury_sample_aud" schemaName="mercury" columnNames="mercury_sample_id, rev"/>
    </changeSet>
    <changeSet id="GPLIM-73-5" author="thompson">
        <addForeignKeyConstraint baseTableName="lab_vessel_mercury_samples" baseTableSchemaName="mercury"
                                 baseColumnNames="mercury_samples"
                                 constraintName="fk_lvms_mercury_sample"
                                 referencedTableName="mercury_sample" referencedTableSchemaName="mercury"
                                 referencedColumnNames="mercury_sample_id"/>
        <addForeignKeyConstraint baseTableName="lab_vessel_mercury_samples" baseTableSchemaName="mercury"
                                 baseColumnNames="lab_vessel"
                                 constraintName="fk_lvms_lab_vessel"
                                 referencedTableName="lab_vessel" referencedTableSchemaName="mercury"
                                 referencedColumnNames="lab_vessel_id"/>
        <addForeignKeyConstraint baseTableName="lab_vessel_mercury_samples_aud" baseTableSchemaName="mercury"
                                 baseColumnNames="rev"
                                 constraintName="fk_lvmsa_rev_info"
                                 referencedTableName="rev_info" referencedTableSchemaName="mercury"
                                 referencedColumnNames="rev_info_id"/>
    </changeSet>

    <changeSet id="GPLIM-73-6" author="thompson">
        <addColumn tableName="lab_vessel" schemaName="mercury">
            <column name="volume" type="float"/>
            <column name="concentration" type="float"/>
        </addColumn>
        <addColumn tableName="lab_vessel_aud" schemaName="mercury">
            <column name="volume" type="float"/>
            <column name="concentration" type="float"/>
        </addColumn>
    </changeSet>
    <changeSet id="GPLIM-22-1" author="scottmat">
        <createTable tableName="bucket" schemaName="mercury">
            <column name="bucket_id" type="number(19,0)">
                <constraints nullable="false" />
            </column>
            <column name="bucket_definition_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey tableName="bucket" schemaName="mercury" columnNames="bucket_id"/>
        <createSequence sequenceName="SEQ_BUCKET" schemaName="mercury" startValue="1" incrementBy="50"/>
        <createIndex tableName="bucket" indexName="ix_b_def_name">
            <column name="bucket_definition_name"/>
        </createIndex>
    </changeSet>
    <changeSet id="GPLIM-22-2" author="scottmat">
        <createTable tableName="bucket_aud" schemaName="mercury">
            <column name="bucket_id" type="number(19,0)">
                <constraints nullable="false" />
            </column>
            <column name="rev" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="revtype" type="number(19,0)">
                <constraints nullable="true"/>
            </column>
            <column name="bucket_definition_name" type="varchar(255)">
                <constraints nullable="true" />
            </column>
        </createTable>
        <addPrimaryKey tableName="bucket_aud" schemaName="mercury" columnNames="bucket_id, rev"/>
    </changeSet>
    <changeSet id="GPLIM-22-3" author="scottmat">
        <createTable tableName="bucket_entry" schemaName="mercury">
            <column name="bucket_entry_id" type="number(19,0)">
                <constraints nullable="false" />
            </column>
            <column name="lab_vessel_id" type="number(19,0)">
                <!-- Foreign key to LabVessels -->
                <constraints nullable="false" />
            </column>
            <column name="po_business_key" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="bucket_existence_id" type="number(19,0)">
                <!--foreign key to bucket -->
                <constraints nullable="true" />
            </column>
            <column name="product_order_ranking" type="number(10,0)">
                <constraints nullable="false" />
            </column>
            <column name="created_date" type="oracle.sql.TIMESTAMP">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey tableName="bucket_entry" schemaName="mercury" columnNames="bucket_entry_id" />
        <createIndex tableName="bucket_entry" indexName="ix_be_lab_vessel_id">
            <column name="lab_vessel_id"/>
        </createIndex>
        <createIndex tableName="bucket_entry" indexName="ix_be_bucket_existence_id">
            <column name="bucket_existence_id"/>
        </createIndex>
        <createSequence sequenceName="SEQ_BUCKET_ENTRY" schemaName="mercury" startValue="1" incrementBy="50"/>
    </changeSet>
    <changeSet id="GPLIM-22-4" author="scottmat">
        <createTable tableName="bucket_entry_aud" schemaName="mercury">
            <column name="bucket_entry_id" type="number(19,0)">
                <constraints nullable="false" />
            </column>
            <column name="rev" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="revtype" type="number(19,0)">
                <constraints nullable="true"/>
            </column>
            <column name="lab_vessel_id" type="number(19,0)">
                <constraints nullable="false" />
            </column>
            <column name="po_business_key" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="bucket_existence_id" type="number(19,0)">
                <constraints nullable="false" />
            </column>
            <column name="product_order_ranking" type="number(10,0)">
                <constraints nullable="false" />
            </column>
            <column name="created_date" type="oracle.sql.TIMESTAMP">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey tableName="bucket_entry_aud" schemaName="mercury" columnNames="bucket_entry_id, rev" />
    </changeSet>
    <changeSet id="GPLIM-22-5" author="scottmat">
        <addForeignKeyConstraint baseTableName="bucket_entry" baseTableSchemaName="mercury"
                                 baseColumnNames="lab_vessel_id"
                                 constraintName="fk_be_lab_vessel_id"
                                 referencedTableName="lab_vessel" referencedTableSchemaName="mercury"
                                 referencedColumnNames="lab_vessel_id"/>
        <addForeignKeyConstraint baseTableName="bucket_entry" baseTableSchemaName="mercury"
                                 baseColumnNames="bucket_existence_id"
                                 constraintName="fk_be_bucket_existence_id"
                                 referencedTableName="bucket" referencedTableSchemaName="mercury"
                                 referencedColumnNames="bucket_id"/>
    </changeSet>
    <changeSet id="GPLIM-273-1" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="lab_event" columnName="product_order_id" schemaName="mercury"/>
            </not>
        </preConditions>
        <addColumn tableName="lab_event">
            <column name="product_order_id" type="varchar(255)"/>
        </addColumn>
    </changeSet>
    <changeSet id="GPLIM-273-2" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="lab_event_aud" columnName="product_order_id" schemaName="mercury"/>
            </not>
        </preConditions>
        <addColumn tableName="lab_event_aud">
            <column name="product_order_id" type="varchar(255)"/>
        </addColumn>
    </changeSet>
    <changeSet id="GPLIM-273-3" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="lab_batch" columnName="created_on" schemaName="mercury" />
            </not>
        </preConditions>
        <addColumn tableName="lab_batch">
            <column name="created_on"  type="oracle.sql.TIMESTAMP" />
        </addColumn>

    </changeSet>
    <changeSet id="GPLIM-273-4" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="lab_batch_aud" columnName="created_on" schemaName="mercury" />
            </not>
        </preConditions>
        <addColumn tableName="lab_batch_aud">
            <column name="created_on"  type="oracle.sql.TIMESTAMP" />
        </addColumn>
    </changeSet>
    
    <changeSet id="GPLIM-73-7" author="thompson">
        <dropColumn tableName="lab_event" columnName="dtype" schemaName="mercury"/>
    </changeSet>
    <changeSet id="GPLIM-73-8" author="thompson">
        <dropColumn tableName="lab_event_aud" columnName="dtype" schemaName="mercury"/>
    </changeSet>
    <changeSet id="GPLIM-73-10" author="thompson">
        <addUniqueConstraint tableName="molecular_indexing_scheme" columnNames="name"
                             constraintName="uk_mis_name" schemaName="mercury"/>
    </changeSet>

    <changeSet id="GPLIM-362-1" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyName="FKD13659683B570EF2" schemaName="mercury" />
        </preConditions>
        <dropForeignKeyConstraint
            constraintName="FKD13659683B570EF2" baseTableName="lab_event" />
    </changeSet>
    <changeSet id="GPLIM-362-2" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyName="FKB8B4430A746A02ED" schemaName="mercury" />
        </preConditions>
        <dropForeignKeyConstraint
            constraintName="FKB8B4430A746A02ED" baseTableName="sequencing_run" />
    </changeSet>

    <!--
    todo jmt enable these constraints
    <changeSet id="GPLIM-73-9" author="thompson">
        <addUniqueConstraint tableName="molecular_index_position" columnNames="SCHEME_ID, POSITION_HINT"
                             constraintName="uk_mip_scheme_position" schemaName="mercury"/>
    </changeSet>
-->
    <changeSet id="GPLIM-73-11" author="thompson">
        <addUniqueConstraint tableName="molecular_index" columnNames="sequence"
                             constraintName="uk_mi_sequence" schemaName="mercury"/>
    </changeSet>

    <changeSet id="GPLIM-73-12" author="thompson">
        <createTable tableName="reagent_design" schemaName="mercury">
            <column name="reagent_design_id" type="number(19,0)">
                <constraints primaryKey="true"/>
            </column>
            <column name="manufacturers_name" type="varchar2(255)"/>
            <column name="reagent_design" type="varchar2(255)"/>
            <column name="reagent_type" type="varchar2(255)"/>
            <column name="target_set_name" type="varchar2(255)"/>
        </createTable>
        <createSequence sequenceName="SEQ_REAGENT_DESIGN" schemaName="mercury" startValue="1" incrementBy="50"/>
    </changeSet>
    <changeSet id="GPLIM-73-13" author="thompson">
        <createTable tableName="reagent_design_aud">
            <column name="reagent_design_id" type="number(19,0)">
                <constraints primaryKey="true"/>
            </column>
            <column name="rev" type="number(19,0)">
                <constraints primaryKey="true"/>
            </column>
            <column name="revtype" type="number(3,0)"/>
            <column name="manufacturers_name" type="varchar2(255)"/>
            <column name="reagent_design" type="varchar2(255)"/>
            <column name="reagent_type" type="varchar2(255 char)"/>
            <column name="target_set_name" type="varchar2(255)"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="reagent_design_aud" baseTableSchemaName="mercury"
                                 baseColumnNames="rev"
                                 constraintName="fk_rd_rev_info"
                                 referencedTableName="rev_info" referencedTableSchemaName="mercury"
                                 referencedColumnNames="rev_info_id"/>
    </changeSet>
    <changeSet id="GPLIM-73-14" author="thompson">
        <addColumn tableName="reagent" schemaName="mercury">
            <column name="reagent_design" type="number(19,0)"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="reagent" baseColumnNames="reagent_design"
                                 constraintName="fk_r_reagent_design"
                                 referencedTableName="reagent_design"
                                 referencedColumnNames="reagent_design_id"/>
    </changeSet>
    <changeSet id="GPLIM-73-15" author="thompson">
        <addColumn tableName="reagent_aud" schemaName="mercury">
            <column name="reagent_design" type="number(19,0)"/>
        </addColumn>
    </changeSet>

    <changeSet id="GPLIM-73-16" author="thompson">
        <createTable tableName="lab_vessel_racks_of_tubes" schemaName="mercury">
            <column name="lab_vessel" type="number(19,0)">
                <constraints primaryKey="true"/>
            </column>
            <column name="racks_of_tubes" type="number(19,0)">
                <constraints primaryKey="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="lab_vessel_racks_of_tubes" baseColumnNames="racks_of_tubes"
                                 constraintName="fk_lvrt_rack_of_tubes" referencedTableName="lab_vessel"
                                 referencedColumnNames="lab_vessel_id"/>
        <addForeignKeyConstraint baseTableName="lab_vessel_racks_of_tubes" baseColumnNames="lab_vessel"
                                 constraintName="fk_lvrt_lab_vessel" referencedTableName="lab_vessel"
                                 referencedColumnNames="lab_vessel_id"/>
    </changeSet>
    <changeSet id="GPLIM-73-17" author="thompson">
        <createTable tableName="lab_vessel_racks_of_tubes_aud" schemaName="mercury">
            <column name="rev" type="number(19,0)">
                <constraints primaryKey="true"/>
            </column>
            <column name="lab_vessel" type="number(19,0)">
                <constraints primaryKey="true"/>
            </column>
            <column name="racks_of_tubes" type="number(19,0)">
                <constraints primaryKey="true"/>
            </column>
            <column name="revtype" type="number(3,0)"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="lab_vessel_racks_of_tubes_aud" baseColumnNames="rev"
                                 constraintName="fk_lvrta_rev_info" referencedTableName="rev_info"
                                 referencedColumnNames="rev_info_id"/>
    </changeSet>

    <changeSet id="GPLIM-378-1" author="scottmat">
        <preConditions>
            <tableExists tableName="person" schemaName="mercury" />
        </preConditions>
        <dropTable tableName="person" schemaName="mercury" />
    </changeSet>

    <changeSet id="GPLIM-378-2" author="scottmat">
        <preConditions>
            <tableExists tableName="person_aud" schemaName="mercury" />
        </preConditions>
        <dropTable tableName="person_aud" schemaName="mercury" />
    </changeSet>
    <changeSet id="GPLIM-308-11" author="dryan">
        <preConditions>
            <indexExists schemaName="mercury" indexName="uk_reagent_design"/>
        </preConditions>
            <addUniqueConstraint tableName="reagent_design" columnNames="reagent_design,reagent_type"
                                 constraintName="uk_reagent_design" schemaName="mercury"/>
        </changeSet>
</databaseChangeLog>
