<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <!-- changeSet ids include the ticket number, with -n appended to allow multiple changeSets per ticket.
     Keep changeSets small, it's harder to recover from an error in a large changeSet.
      -->

    <changeSet id="GPLIM-1376-1" author="thompson">
        <addColumn tableName="LAB_BATCH" schemaName="MERCURY">
            <column name="WORKFLOW_NAME" type="varchar(255)"></column>
        </addColumn>
    </changeSet>
    <changeSet id="GPLIM-1376-2" author="thompson">
        <addColumn tableName="LAB_BATCH_AUD" schemaName="MERCURY">
            <column name="WORKFLOW_NAME" type="varchar(255)"></column>
        </addColumn>
    </changeSet>
    <changeSet id="GPLIM-1377-1" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <columnExists schemaName="mercury" tableName="lv_comment" columnName="lab_event"/>
        </preConditions>
        <dropNotNullConstraint columnName="lab_event" schemaName="mercury" tableName="lv_comment"/>
    </changeSet>
    <changeSet id="GPLIM-1377-2" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <columnExists schemaName="mercury" tableName="lv_comment_aud" columnName="lab_event"/>
        </preConditions>
        <dropNotNullConstraint columnName="lab_event" schemaName="mercury" tableName="lv_comment_aud"/>
    </changeSet>
    <changeSet id="GPLIM-1377-3" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyName="FK_LV_COMMENT_LAB_EVENT" schemaName="mercury"/>
        </preConditions>
        <dropForeignKeyConstraint
                constraintName="FK_LV_COMMENT_LAB_EVENT" baseTableName="lv_comment" baseTableSchemaName="mercury"/>
    </changeSet>

    <changeSet id="GPLIM-1434-1" author="jcarey">
        <createTable tableName="batch_starting_vessels" schemaName="mercury">
            <column name="batch_starting_vessel_id" type="number(19,0)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="lab_vessel" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="lab_batch" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="concentration" type="number(19,2)"/>
        </createTable>

        <createIndex tableName="batch_starting_vessels" indexName="ix_lab_vessel_key">
            <column name="lab_vessel"/>
        </createIndex>

        <createIndex tableName="batch_starting_vessels" indexName="ix_lab_batch_key">
            <column name="lab_batch"/>
        </createIndex>

        <createSequence sequenceName="SEQ_BATCH_STARTING_VESSEL" schemaName="mercury" startValue="1"
                        incrementBy="50"/>
    </changeSet>
    <changeSet id="GPLIM-1434-2" author="jcarey">

        <createTable tableName="batch_starting_vessels_aud" schemaName="mercury">
            <column name="batch_starting_vessel_id" type="number(19,0)" />
            <column name="lab_vessel" type="number(19,0)" />
            <column name="lab_batch" type="number(19,0)" />
            <column name="concentration" type="number(19,2)"/>
            <column name="rev" type="number(19,0)" />
            <column name="revtype" type="number(3,0)" />
        </createTable>

        <addPrimaryKey tableName="batch_starting_vessels_aud" schemaName="mercury"
                       columnNames="batch_starting_vessel_id, rev"/>

    </changeSet>
    <changeSet id="GPLIM-1606-1" author="scottmat">
        <preConditions>
            <not>
                <columnExists tableName="sequencing_run" columnName="actual_read_structure" schemaName="mercury"/>
            </not>
        </preConditions>
        <addColumn tableName="sequencing_run" schemaName="mercury">
            <column name="actual_read_structure" type="varchar(255)"></column>
        </addColumn>
    </changeSet>
    <changeSet id="GPLIM-1606-2" author="scottmat">
        <preConditions>
            <not>
                <columnExists tableName="sequencing_run_aud" columnName="actual_read_structure" schemaName="mercury"/>
            </not>
        </preConditions>
        <addColumn tableName="sequencing_run_aud" schemaName="mercury">
            <column name="actual_read_structure" type="varchar(255)"></column>
        </addColumn>
    </changeSet>
    <changeSet id="GPLIM-1606-3" author="scottmat">
        <preConditions>
            <not>
                <columnExists tableName="sequencing_run" columnName="setup_read_structure" schemaName="mercury"/>
            </not>
        </preConditions>
        <addColumn tableName="sequencing_run" schemaName="mercury">
            <column name="setup_read_structure" type="varchar(255)"></column>
        </addColumn>
    </changeSet>
    <changeSet id="GPLIM-1606-4" author="scottmat">
        <preConditions>
            <not>
                <columnExists tableName="sequencing_run_aud" columnName="setup_read_structure" schemaName="mercury"/>
            </not>
        </preConditions>
        <addColumn tableName="sequencing_run_aud" schemaName="mercury">
            <column name="setup_read_structure" type="varchar(255)"></column>
        </addColumn>
    </changeSet>

    <changeSet id="GPLIM-1377-4" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="ENTRY_TYPE" schemaName="mercury" tableName="BUCKET_ENTRY"/>
            </not>
        </preConditions>
        <addColumn tableName="BUCKET_ENTRY" schemaName="mercury">
            <column name="ENTRY_TYPE" type="varchar(255)"></column>
        </addColumn>
    </changeSet>
    <changeSet id="GPLIM-1377-5" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="ENTRY_TYPE" schemaName="mercury" tableName="BUCKET_ENTRY_AUD"/>
            </not>
        </preConditions>
        <addColumn tableName="BUCKET_ENTRY_AUD" schemaName="mercury">
            <column name="ENTRY_TYPE" type="varchar(255)"></column>
        </addColumn>
    </changeSet>
    <changeSet id="GPLIM-1377-6" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="ENTRY_TYPE" schemaName="mercury" tableName="BUCKET_ENTRY"/>
        </preConditions>
        <update schemaName="mercury" tableName="BUCKET_ENTRY">
            <column name="ENTRY_TYPE" value="PDO_ENTRY"></column>
            <where>ENTRY_TYPE is null</where>
        </update>
    </changeSet>
    <changeSet id="GPLIM-1377-7" author="scottmat">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="ENTRY_TYPE" schemaName="mercury" tableName="BUCKET_ENTRY_AUD"/>
        </preConditions>
        <update schemaName="mercury" tableName="BUCKET_ENTRY_AUD">
            <column name="ENTRY_TYPE" value="PDO_ENTRY"></column>
            <where>ENTRY_TYPE is null</where>
        </update>
    </changeSet>

    <changeSet id="GPLIM-1377-8" author="breilly">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="rework_detail" schemaName="mercury"/>
            </not>
        </preConditions>
        <createTable tableName="rework_detail" schemaName="mercury">
            <column name="rework_detail_id" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="rework_level" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="rework_reason" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="rework_step" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="rework_comment" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="rework_detail" schemaName="mercury" columnNames="rework_detail_id"/>
        <createSequence sequenceName="SEQ_REWORK_DETAIL" schemaName="mercury" startValue="1" incrementBy="50"/>
    </changeSet>
    <changeSet id="GPLIM-1377-9" author="breilly">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="rework_detail_aud" schemaName="mercury"/>
            </not>
        </preConditions>
        <createTable tableName="rework_detail_aud" schemaName="mercury">
            <column name="rework_detail_id" type="number(19,0)">
                <constraints nullable="false"/>
            </column>
            <column name="rev" type="number(19,0)">
                <constraints nullable="true"/>
            </column>
            <column name="revtype" type="number(3,0)">
                <constraints nullable="true"/>
            </column>
            <column name="rework_level" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="rework_reason" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="rework_step" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="rework_comment" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="rework_detail_aud" schemaName="mercury" columnNames="rework_detail_id, rev"/>
        <addForeignKeyConstraint baseTableName="rework_detail_aud" baseTableSchemaName="mercury" baseColumnNames="rev"
                                 constraintName="fk_rework_detail_aud_rev_info"
                                 referencedTableName="rev_info" referencedTableSchemaName="mercury"
                                 referencedColumnNames="rev_info_id"/>
    </changeSet>
    <changeSet id="GPLIM-1377-10" author="breilly">
        <addColumn tableName="bucket_entry" schemaName="mercury">
            <column name="rework_detail_id" type="number(19,0)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint baseTableName="bucket_entry" baseTableSchemaName="mercury"
                                 baseColumnNames="rework_detail_id"
                                 constraintName="fk_bucket_entry_rework_detail"
                                 referencedTableName="rework_detail" referencedTableSchemaName="mercury"
                                 referencedColumnNames="rework_detail_id"/>
    </changeSet>
    <changeSet id="GPLIM-1377-11" author="breilly">
        <addColumn tableName="bucket_entry_aud" schemaName="mercury">
            <column name="rework_detail_id" type="number(19,0)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="GPLIM-1377-12" author="breilly">
        <addColumn tableName="rework_detail">
            <column name="add_to_rework_bucket_event_id" type="number(19,0)"/>
        </addColumn>
        <addColumn tableName="rework_detail_aud">
            <column name="add_to_rework_bucket_event_id" type="number(19,0)"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="rework_detail" baseTableSchemaName="mercury"
                                 baseColumnNames="add_to_rework_bucket_event_id"
                                 constraintName="fk_rework_detail_lab_event"
                                 referencedTableName="lab_event" referencedTableSchemaName="mercury"
                                 referencedColumnNames="lab_event_id"/>
    </changeSet>
</databaseChangeLog>