<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui">
<body>
    <ui:composition template="/layout.xhtml">
        <ui:define name="metadata">
            <f:metadata>
                <!-- cannot be required="true" due to http://java.net/jira/browse/JAVASERVERFACES-1532 and p:dataTable with p:ajax -->
                <f:viewParam name="runName" value="#{illuminaRunQuery.runName}"/>
                <f:event type="preRenderView" listener="#{illuminaRunQuery.query}"/>
            </f:metadata>
        </ui:define>
        <ui:define name="title">Illumina Run</ui:define>
        <ui:define name="head">
            <style type="text/css">
                .ui-selectcheckboxmenu-panel {
                    width: 250px;
                }
            </style>
        </ui:define>
        <ui:define name="body">

            <h:form id="form">
                <table width="100%"><tr>
                    <td>

                        <!-- OVERALL RUN DETAILS -->
                        <h:panelGrid columns="2">
                            <h:outputText value="Run Name:"/>
                            <h:outputText id="runNameOutput" value="#{illuminaRunQuery.run.name}"/>

                            <h:outputText value="Run Barcode:"/>
                            <h:outputText id="runBarcodeOutput" value="#{illuminaRunQuery.run.barcode}"/>

                            <h:outputText value="Run Date:"/>
                            <h:outputText id="runDateOutput" value="#{illuminaRunQuery.run.runDateString}"/>

                            <h:outputText value="Sequencer:"/>
                            <h:outputText id="sequencerOutput" value="#{illuminaRunQuery.run.sequencer}"/>

                            <h:outputText value="Sequencer Model:"/>
                            <h:outputText id="sequencerModelOutput" value="#{illuminaRunQuery.run.sequencerModel}"/>

                            <h:outputText value="Flowcell Barcode:"/>
                            <h:outputText id="flowcellBarcodeOutput" value="#{illuminaRunQuery.run.flowcellBarcode}"/>

                            <h:outputText value="Paired:"/>
                            <h:outputText id="pairedOutput" value="#{illuminaRunQuery.run.pairedRun ? 'Yes' : 'No'}"/>

                            <h:outputText value="First Cycle:"/>
                            <h:outputText id="firstCycleOutput" value="#{illuminaRunQuery.run.firstCycle}"/>

                            <h:outputText value="First Cycle Read Length:"/>
                            <h:outputText id="firstCycleReadLengthOutput" value="#{illuminaRunQuery.run.firstCycleReadLength}"/>

                            <h:outputText value="Last Cycle:"/>
                            <h:outputText id="lastCycleOutput" value="#{illuminaRunQuery.run.lastCycle}"/>

                            <h:outputText value="Molecular Barcode Cycle:"/>
                            <h:outputText id="molecularBarcodeCycleOutput" value="#{illuminaRunQuery.run.molecularBarcodeCycle}"/>

                            <h:outputText value="Molecular Barcode Length:"/>
                            <h:outputText id="molecularBarcodeLengthOutput" value="#{illuminaRunQuery.run.molecularBarcodeLength}"/>
                        </h:panelGrid>
                    </td>

                    <td>

                        <!-- LANE SUMMARY -->
                        <p:dataTable id="lanes" value="#{illuminaRunQuery.lanes}" var="lane" selectionMode="single" selection="#{illuminaRunQuery.selectedLane}" rowKey="#{lane.name}">

                            <p:ajax event="rowSelect" update=":form:libraryTable"/>

                            <f:facet name="header">Lanes</f:facet>

                            <p:column headerText="Lane">
                                #{lane.name}
                            </p:column>
                            <p:column headerText="Primer">
                                #{lane.primer}
                            </p:column>
                            <p:column headerText="Libraries">
                                #{lane.libraries.size()}
                            </p:column>
                            <p:column headerText="Sequenced Library">
                                #{lane.sequencedLibrary}
                            </p:column>
                        </p:dataTable>
                    </td>
                </tr></table>

                <p/>

                <!-- LIBRARY DETAILS FOR SELECTED LANE -->
                <p:dataTable id="libraryTable" value="#{illuminaRunQuery.selectedLane == null ? null : illuminaRunQuery.selectedLane.libraries}" var="library" emptyMessage="Select a lane">
                    <f:facet name="header">
                        <h:outputText id="laneDetailsHeader" value="Lane #{illuminaRunQuery.selectedLane.name} Details (#{illuminaRunQuery.selectedLane.sequencedLibrary})"/>
                        <div style="float: right">
                            <p:selectCheckboxMenu id="laneDetailColumns" value="#{illuminaRunQuery.columnNames}" label="Lane Detail Columns" height="300">
                                <p:ajax event="change" update=":form:libraryTable"/>
                                <f:selectItems value="#{illuminaRunQuery.allColumnNames}" var="columnName" itemLabel="#{columnName}"/>
                            </p:selectCheckboxMenu>
                        </div>
                    </f:facet>

                    <p:column>
                        <p:rowToggler/>
                    </p:column>

                    <p:rowExpansion>
                        <p:dataTable value="#{illuminaRunQuery.allColumns}" var="column">
                            <p:column>
                                #{column.header}
                            </p:column>
                            <p:column>
                                <h:outputText value="#{library[column.property]}" rendered="#{column.property != null}"/>
                                <h:outputText value="#{illuminaRunQuery.eval(column.expression)}" rendered="#{column.expression != null}"/>
                            </p:column>
                        </p:dataTable>
                    </p:rowExpansion>

                    <p:column headerText="Library Name" filterBy="#{library.library}" filterMatchMode="contains">
                        #{library.library}
                    </p:column>

                    <p:columns value="#{illuminaRunQuery.columns}" var="column" columnIndexVar="i">
                        <f:facet name="header">
                            #{column.header}
                        </f:facet>
                        <h:outputText value="#{library[column.property]}" rendered="#{column.property != null}"/>
                        <h:outputText value="#{illuminaRunQuery.eval(column.expression)}" rendered="#{column.expression != null}"/>
                    </p:columns>
                </p:dataTable>
            </h:form>

            <p/>

            <!-- READ SUMMARY -->
            <p:dataTable id="reads" value="#{illuminaRunQuery.reads}" var="read">
                <f:facet name="header">Reads</f:facet>

                <p:column headerText="Read Type">
                    #{read.readType}
                </p:column>
                <p:column headerText="First Cycle">
                    #{read.firstCycle}
                </p:column>
                <p:column headerText="Length">
                    #{read.length}
                </p:column>
            </p:dataTable>

        </ui:define>
    </ui:composition>
</body>
</html>
